<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Parking Recommender</title>

    <!-- ✅ Leaflet CSS (no integrity / crossorigin) -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        header {
            padding: 0.75rem 1rem;
            background: #222;
            color: #f5f5f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        #controls input, #controls button {
            padding: 0.25rem 0.5rem;
            font-size: 0.9rem;
        }

        #map {
            width: 100%;
            height: calc(100vh - 56px); /* header height */
            border-top: 1px solid #444;
            box-sizing: border-box;
        }

        #status {
            font-size: 0.8rem;
            opacity: 0.8;
        }
    </style>
</head>
<body>
<header>
    <div>
        <strong>Parking Recommender</strong>
    </div>
    <div id="controls">
        <label>
            Radius (m)
            <input type="number" id="radius-input" value="500" min="50" step="50">
        </label>
        <button id="search-button">Search around map center</button>
        <span id="status"></span>
    </div>
</header>

<div id="map"></div>

<!-- ✅ Leaflet JS (no integrity / crossorigin) -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Default center: Downtown LA-ish
        const DEFAULT_LAT = 34.0522;
        const DEFAULT_LNG = -118.2437;

        const map = L.map('map').setView([DEFAULT_LAT, DEFAULT_LNG], 15);

        // Base tiles (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Layer group for markers so we can clear them
        const markersLayer = L.layerGroup().addTo(map);

        const statusEl = document.getElementById('status');
        const radiusInput = document.getElementById('radius-input');
        const searchButton = document.getElementById('search-button');

        function setStatus(msg) {
            statusEl.textContent = msg;
        }

 async function searchAroundCenter(isRetry = false) {
    const center = map.getCenter();
    let radius = parseInt(radiusInput.value, 10) || 500;

    setStatus(`Searching within ${radius} m…`);

    const url = `/api/search?lat=${center.lat}&lng=${center.lng}&radiusMeters=${radius}`;

    try {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error('HTTP ' + response.status);
        }

        const meters = await response.json();

        // If no results AND this was a small radius AND we haven't retried yet,
        // bump radius to 500 and try one more time.
        if ((!Array.isArray(meters) || meters.length === 0) &&
            radius < 500 && !isRetry) {

            radius = 500;
            radiusInput.value = 500;
            setStatus('No meters in that radius. Trying 500 m instead…');

            // Retry once with 500 m
            return searchAroundCenter(true);
        }

        // Clear old markers
        markersLayer.clearLayers();

        if (!Array.isArray(meters) || meters.length === 0) {
            setStatus(`No meters found within ${radius} m.`);
            return;
        }

        meters.forEach(m => {
            const marker = L.marker([m.lat, m.lng]).addTo(markersLayer);
            marker.bindPopup(`
                <strong>${m.name}</strong><br/>
                Spaces: ${m.spaces}<br/>
                Distance: ${m.distanceMeters.toFixed(1)} m<br/>
                Lat: ${m.lat.toFixed(6)}, Lng: ${m.lng.toFixed(6)}
            `);
        });

        setStatus(`Loaded ${meters.length} meter(s) within ${radius} m.`);
    } catch (err) {
        console.error(err);
        setStatus('Error fetching /api/search.');
    }
}

    

        // Button triggers search
        searchButton.addEventListener('click', searchAroundCenter);

        // Do one search at startup
        searchAroundCenter();
    });
</script>

</body>
</html>
